set(CALL16_THUNK_SOURCE ${CMAKE_CURRENT_SOURCE_DIR}/call16_thunk.asm)
set(CALL16_THUNK_BINARY ${CMAKE_CURRENT_BINARY_DIR}/call16_thunk.bin)
set(CALL16_THUNK_ORG    0x500)
set(CALL16_THUNK_DEFINE -d G_ORG="${CALL16_THUNK_ORG}")

find_program(FASM fasm)

add_custom_command(OUTPUT ${CALL16_THUNK_BINARY}
  BYPRODUCTS ${CALL16_THUNK_BINARY}
  COMMAND ${FASM} ${CALL16_THUNK_DEFINE} ${CALL16_THUNK_SOURCE} ${CALL16_THUNK_BINARY} 
  DEPENDS ${CALL16_THUNK_SOURCE}
  MAIN_DEPENDENCY  ${CALL16_THUNK_SOURCE}
  WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
  COMMENT "Compiling call16_thunk.bin"
)  

add_custom_target(call16_thunk_bin ALL DEPENDS ${CALL16_THUNK_BINARY} SOURCES ${CALL16_THUNK_SOURCE})

set_property(SOURCE call16_thunk.s PROPERTY OBJECT_DEPENDS ${CALL16_THUNK_BINARY})
set_property(SOURCE call16_thunk.s PROPERTY COMPILE_DEFINITIONS "CALL16_THUNK_BINARY=\"${CALL16_THUNK_BINARY}\"" "CALL16_THUNK_ORG=${CALL16_THUNK_ORG}" )

add_library(call16_thunk call16_thunk.s)

target_include_directories(call16_thunk PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

target_compile_options(call16_thunk PRIVATE -fno-lto)

add_dependencies(call16_thunk call16_thunk_bin)